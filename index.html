<!DOCTYPE html>
<html lang="jp">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <title>簡単でらスコ計算機</title>
</head>
<body>
<header class="site-header has-background-light p-3">
  <div class="container">
    <h1 class="title is-6">maimai 簡易でらすこ計算機</h1>
  </div>
</header>

<div id="calcApp" class="section">
  <div class="container">
    <h1 class="title">■ノーツ数から計算</h1>
    <!-- 入力エリア -->
    <div class="field">
      <label class="label">ノーツ数：</label>
      <div class="control">
        <input type="number" class="input" v-model="numNotes" min="1" max="9999" placeholder="例：500" @input="validateInput">
      </div>
      <p class="help is-danger" v-if="errorMessage">{{ errorMessage }}</p>
      <div class="control mt-3 has-text-centered">
        <button class="button is-primary" @click="calculate" :disabled="!isValid">計算</button>
      </div>
    </div>

    <!-- 結果テーブル -->
    <div class="scrollable-table mt-5" v-if="Object.keys(results).length">
      <table class="table is-bordered is-striped is-fullwidth">
        <thead>
          <tr>
            <th class="fixed-title"></th>
            <th style="width: 7em;">でらスコ</th>
            <th style="width: 14em;">許容ノーツ数（PERFECT）</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(result, label) in results" :key="label">
            <th class="fixed-title">{{ label }}</th>
            <td>{{ result.score }}</td>
            <td>{{ result.tolerance }}</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<div class="section" id="searchApp">
  <h1 class="title">■楽曲から探す</h1>

  <div class="field">
    <label class="label">検索</label>
    <div class="control">
      <input v-model="keyword" class="input" type="text" placeholder="楽曲名を入力（一部でも可）" @input="validateSearchInput">
    </div>
    <p class="help is-danger" v-if="errorMessage">{{ searchError }}</p>
  </div>

  <div class="scrollable-table" v-if="filteredData.length">
    <table class="table is-striped is-fullwidth">
      <thead>
        <tr>
          <th v-for="(key, i) in headers" :key="key" :class="i === 0 ? 'fixed-title' : ''">
            {{ headerLabels[key] || key }}
          </th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(row, i) in filteredData" :key="i">
          <td v-for="(key, j) in headers" :key="key" :class="j === 0 ? 'fixed-title' : (key.endsWith('_notes') ? 'clickable' : '')" @click="key.endsWith('_notes') && fillNotes(row[key])">
            {{ key === 'version' ? versionMap[row[key].toString().slice(0, 3) + '00'] || row[key] : row[key] }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <p v-else>該当データがありません。</p>
</div>


<footer>
  <p>ご意見・ご連絡は <a href="https://twitter.com/your_account" target="_blank" rel="noopener">@your_account</a> まで</p>
  <p>&copy; 2025 Delasco Calc. All rights reserved.</p>
</footer>


<script>
  //楽曲検索バリデーション
  function isValidKeyword(input) {
    const trimmed = input.trim();
    if (!trimmed) return { valid: false, message: '検索キーワードを入力してください。' };
    const dangerousPattern = /<script.*?>|<\/script>|['"];]/i;
    if (dangerousPattern.test(trimmed)) {
      return { valid: false, message: '不正な文字列が含まれています。' };
    }
    return { valid: true, message: '' };
  }

  //でらスコ計算ロジック
  const calcAppInstance = Vue.createApp({
    data() {
      return {
        numNotes: null,
        maxPerNote: 3,
        precisionLevels: {
          '理論値': 1.00,
          '★6': 0.99,
          '★5': 0.97,
          '★4': 0.95,
          '★3': 0.93,
          '★2': 0.90,
          '★1': 0.85,
        },
        results: {},
        errorMessage: ''
      };
    },
    computed: {
      isValid() {
      const value = Number(this.numNotes);
      return (
        this.errorMessage === '' &&
        Number.isInteger(value) &&
        value >= 1 &&
        value <= 9999
      );
    }
  },
  methods: {
    validateInput() {
      const value = Number(this.numNotes);
      if (
        isNaN(value) ||
        !Number.isInteger(value) ||
        value < 1 ||
        value > 9999
      ) {
        this.errorMessage = '1〜9999の整数を入力してください';
        this.results = {};
      } else {
        this.errorMessage = '';
      }
    },
    calculate() {
      if (this.errorMessage) return;

      const baseScore = this.numNotes * this.maxPerNote;
      const resultSet = {};

      for (const [label, rate] of Object.entries(this.precisionLevels)) {
        const score = Math.ceil(baseScore * rate);
        const tolerance = Math.ceil(baseScore - score);
        resultSet[label] = { score, tolerance };
      }

      this.results = resultSet;
    }
  }
}).mount('#calcApp');

  //楽曲検索ロジック
  Vue.createApp({
    data() {
      return {
        rawData: [],
        keyword: '',
        displayColumns: [
          'title', 'version',
          'lev_mas', 'dx_lev_mas',
          'lev_mas_notes', 'dx_lev_mas_notes',
          'lev_exp', 'dx_lev_exp',
          'lev_exp_notes', 'dx_lev_exp_notes',
          'lev_adv', 'dx_lev_adv',
          'lev_adv_notes', 'dx_lev_adv_notes',
          'lev_bas', 'dx_lev_bas',
          'lev_bas_notes', 'dx_lev_bas_notes'
        ],
        headerLabels: {
          title: 'タイトル',
          version: 'バージョン',
          lev_mas: 'MASTER Lv.',
          dx_lev_mas: 'MASTER Lv. DX',
          lev_mas_notes: 'MASTERノーツ数',
          dx_lev_mas_notes: 'MASTERノーツ数 DX',
          lev_exp: 'EXPERT Lv.',
          dx_lev_exp: 'EXPERT Lv. DX',
          lev_exp_notes: 'EXPERTノーツ数',
          dx_lev_exp_notes: 'EXPERTノーツ数 DX',
          lev_adv: 'ADVANCE Lv.',
          dx_lev_adv: 'ADVANCE Lv. DX',
          lev_adv_notes: 'ADVANCEノーツ数',
          dx_lev_adv_notes: 'ADVANCEノーツ数 DX',
          lev_bas: 'BASIC Lv.',
          dx_lev_bas: 'BASIC Lv. DX',
          lev_bas_notes: 'BASICノーツ数',
          dx_lev_bas_notes: 'BASICノーツ数 DX'
        },
        versionMap: {
          "10000": "maimai",
          "11000": "maimai PLUS",
          "12000": "GreeN",
          "13000": "GreeN PLUS",
          "14000": "ORANGE",
          "15000": "ORANGE PLUS",
          "16000": "PiNK",
          "17000": "PiNK PLUS",
          "18000": "MURASAKi",
          "18500": "MURASAKi PLUS",
          "19000": "MiLK",
          "19500": "MiLK PLUS",
          "19900": "FiNALE",
          "20000": "でらっくす",
          "20500": "でらっくす PLUS",
          "21000": "Splash",
          "21500": "Splash PLUS",
          "22000": "UNiVERSE",
          "22500": "UNiVERSE PLUS",
          "23000": "FESTiVAL",
          "23500": "FESTiVAL PLUS",
          "24000": "BUDDiES",
          "24500": "BUDDiES PLUS",
          "25000": "PRiSM",
          "25500": "PRiSM PLUS"
        },
        searchError: '',
      };
    },
    computed: {
      headers() {
        return this.displayColumns;
      },
      filteredData() {
        if (this.searchError) return []; // エラー時は表示しない
        
        const kw = this.keyword.toLowerCase();
        return this.rawData.filter(row =>
          Object.values(row).some(val =>
            String(val).toLowerCase().includes(kw)
          )
        );
      }
    },
    methods: {
      validateSearchInput() {
        const result = isValidKeyword(this.keyword);
        this.searchError = result.message;
        return result.valid;
      },
      fillNotes(noteCount) {
        if (noteCount == null || isNaN(Number(noteCount))) return;

        const proxy = calcAppInstance;
        proxy.numNotes = Number(noteCount);
        proxy.validateInput();
      }
    },

    async mounted() {
      const res = await fetch("data/music-ex.json");
      this.rawData = await res.json();
    }
  }).mount('#searchApp');
</script>

</body>
</html>