<!DOCTYPE html>
<html lang="jp">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <title>calc</title>
</head>
<body>
<header class="site-header">
  <div>
    <p>でらすこ計算機β</p>
  </div>
</header>

<div id="calcApp" class="section">
  <div class="container">
    <h1 class="title">ノーツ数からでらスコを計算</h1>
    <!-- 入力エリア -->
    <div class="field">
      <label class="label">ノーツ数：</label>
      <div class="control">
        <input type="number" class="input" v-model="numNotes" min="1" max="9999" placeholder="例：500 もしくは、楽曲からノーツ数を探す" @input="validateInput">
      </div>
      <p class="help is-danger" v-if="errorMessage">{{ errorMessage }}</p>
      <div class="control mt-3">
        <button class="button is-primary" @click="calculate" :disabled="!isValid">計算</button>
      </div>
    </div>

    <!-- 結果テーブル -->
    <table class="table is-bordered is-striped is-fullwidth mt-5" v-if="Object.keys(results).length">
      <thead>
        <tr>
          <th></th>
          <th>でらスコ</th>
          <th>許容ノーツ数（PERFECT）</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(result, label) in results" :key="label">
          <th>{{ label }}</th>
          <td>{{ result.score }}</td>
          <td>{{ result.tolerance }}</td>
        </tr>
      </tbody>
    </table>

  </div>
</div>

<div class="container" id="searchApp">
  <h1 class="title">楽曲からノーツ数を探す</h1>

  <div class="field">
    <label class="label">検索</label>
    <div class="control">
      <input v-model="keyword" class="input" type="text" placeholder="楽曲名を入力（一部でも可）" @input="validateSearchInput">
    </div>
    <p class="help is-danger" v-if="errorMessage">{{ searchError }}</p>
  </div>

  <table class="table is-striped is-fullwidth" v-if="filteredData.length">
    <thead>
      <tr>
        <th v-for="key in headers" :key="key">{{ key }}</th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="(row, i) in filteredData" :key="i">
        <td v-for="key in headers" :key="key">{{ row[key] }}</td>
      </tr>
    </tbody>
  </table>

  <p v-else>該当データがありません。</p>
</div>


<footer></footer>


<script>
  //でらスコ計算ロジック
  Vue.createApp({
  data() {
    return {
      numNotes: null,
      maxPerNote: 3,
      precisionLevels: {
        '理論値': 1.00,
        '★6': 0.99,
        '★5': 0.97,
        '★4': 0.95,
        '★3': 0.93,
        '★2': 0.90,
        '★1': 0.85,
      },
      results: {},
      errorMessage: ''
    };
  },
  computed: {
    isValid() {
    const value = Number(this.numNotes);
    return (
      this.errorMessage === '' &&
      Number.isInteger(value) &&
      value >= 1 &&
      value <= 9999
    );
  }
  },
  methods: {
    validateInput() {
      const value = Number(this.numNotes);
      if (
        isNaN(value) ||
        !Number.isInteger(value) ||
        value < 1 ||
        value > 9999
      ) {
        this.errorMessage = '1〜9999の整数を入力してください';
        this.results = {};
      } else {
        this.errorMessage = '';
      }
    },
    calculate() {
      if (this.errorMessage) return;

      const baseScore = this.numNotes * this.maxPerNote;
      const resultSet = {};

      for (const [label, rate] of Object.entries(this.precisionLevels)) {
        const score = Math.ceil(baseScore * rate);
        const tolerance = Math.ceil(baseScore - score);
        resultSet[label] = { score, tolerance };
      }

      this.results = resultSet;
    }
  }
}).mount('#calcApp');

  //楽曲検索ロジック
  Vue.createApp({
    data() {
      return {
        rawData: [],
        keyword: '',
        displayColumns: ['title', 'version', 'lev_mas', 'lev_mas_notes', 'lev_exp', 'lev_exp_notes', 'lev_adv', 'lev_adv_notes', 'lev_bas', 'lev_bas_notes'],
        keyword: '',
        searchError: '',
      };
    },
    computed: {
      headers() {
        return this.displayColumns;
      },
      filteredData() {
        if (this.searchError) return []; // エラー時は表示しない
        
        const kw = this.keyword.toLowerCase();
        return this.rawData.filter(row =>
          Object.values(row).some(val =>
            String(val).toLowerCase().includes(kw)
          )
        );
      }
    },
    methods: {
      validateSearchInput() {
        const trimmed = this.keyword.trim();

        // 空またはスペースだけ
        if (!trimmed) {
          this.searchError = '検索キーワードを入力してください。';
          return false;
        }

        // 簡単なスクリプト・インジェクション対策
        const dangerousPattern = /<script.*?>|<\/script>|['";]/i;
        if (dangerousPattern.test(trimmed)) {
          this.searchError = '不正な文字列が含まれています。';
          return false;
        }

        this.searchError = '';
        return true;
      },
      formatValue(col, val) {
        if (col === 'version') {
          return this.versionMap[val] || val;
        }
        return val;
      }
    },
    versionMap: {
      "10000": "maimai",
      "11000": "maimai PLUS",
      "12000": "GreeN",
      "13000": "GreeN PLUS",
      "14000": "ORANGE",
      "15000": "ORANGE PLUS",
      "16000": "PiNK",
      "17000": "PiNK PLUS",
      "18000": "MURASAKi",
      "18500": "MURASAKi PLUS",
      "19000": "MiLK",
      "19500": "MiLK PLUS",
      "19900": "FiNALE",
      "20000": "でらっくす",
      "20500": "でらっくす PLUS",
      "21000": "Splash",
      "21500": "Splash PLUS",
      "22000": "UNiVERSE",
      "22500": "UNiVERSE PLUS",
      "23000": "FESTiVAL",
      "23500": "FESTiVAL PLUS",
      "24000": "BUDDiES",
      "24500": "BUDDiES PLUS",
      "25000": "PRiSM",
      "25500": "PRiSM PLUS"
    },
    async mounted() {
      const res = await fetch("data/music-ex.json");
      this.rawData = await res.json();
    }
  }).mount('#searchApp');
</script>

</body>
</html>